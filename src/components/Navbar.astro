---
const raw = Astro.url.pathname || '/';
const normalize = (p: string) => {
  if (!p) return '/';
  return p === '/' ? '/' : p.replace(/\/+$/, '');
};
const pathname = normalize(raw);
const active = (p: string) => (pathname === normalize(p) ? 'active' : '');

const titleMap: Record<string, string> = {
  '/': 'Home',
  '/about': 'About',
  '/projects': 'Projects',
  '/research': 'Research',
};
const pageTitle = titleMap[pathname] ?? 'Page';
---
<nav class="topbar" aria-label="Primary">
  <div class="row">
    <!-- Left: Logo -->
    <a href="/" class="logo-link" aria-label="Home">
      <img id="logoImg" class="logo" src="/icons/logo dark.png" alt="Logo" />
    </a>

    <!-- Center: Page title (shown only on mobile) -->
    <div class="page-title" aria-hidden="true">{pageTitle}</div>

    <!-- Center: Full menu (hidden on mobile) -->
    <ul class="menu" role="menubar" aria-label="Main">
      <li role="none"><a role="menuitem" class={`link ${active('/')}`} href="/">Home</a></li>
      <li role="none"><a role="menuitem" class={`link ${active('/about')}`} href="/about">About</a></li>
      <li role="none"><a role="menuitem" class={`link ${active('/projects')}`} href="/projects">Projects</a></li>
      <li role="none"><a role="menuitem" class={`link ${active('/research')}`} href="/research">Research</a></li>
    </ul>

    <!-- Right: Theme toggle -->
    <button class="toggle" id="themeToggle" aria-label="Toggle light/dark mode" title="Toggle theme">
      <span id="themeIcon" aria-hidden="true"></span>
    </button>

    <!-- Right: Hamburger (mobile only) -->
    <button
      class="hamburger"
      id="mobileMenuBtn"
      aria-label="Open navigation menu"
      aria-haspopup="menu"
      aria-expanded="false"
      aria-controls="mobileMenu"
    >
      <!-- 3 bars -->
      <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
        <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
      </svg>
    </button>
  </div>

  <!-- Mobile dropdown menu -->
  <div class="mobile-menu" id="mobileMenu" hidden>
    <ul class="mobile-list" role="menu" aria-label="Mobile">
      <li role="none"><a role="menuitem" class={`mlink ${active('/')}`} href="/">Home</a></li>
      <li role="none"><a role="menuitem" class={`mlink ${active('/about')}`} href="/about">About</a></li>
      <li role="none"><a role="menuitem" class={`mlink ${active('/projects')}`} href="/projects">Projects</a></li>
      <li role="none"><a role="menuitem" class={`mlink ${active('/research')}`} href="/research">Research</a></li>
    </ul>
  </div>
</nav>

<script>
  (function(){
    const root = document.documentElement;
    const btn  = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');
    const logo = document.getElementById('logoImg');

    const logos = {
      light: "/icons/logo light.png",
      dark:  "/icons/logo dark.png"
    };

    function setIcon(theme){
      icon.innerHTML = theme === 'dark'
        ? '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21.75 14.5A9.75 9.75 0 1111.5 2.25a8 8 0 0010.25 12.25z"/></svg>'
        : '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9.83-18.16l-1.79-1.79-1.8 1.79 1.8 1.79 1.79-1.79zM20 13h3v-2h-3v2zM6.76 19.16l-1.8 1.79 1.41 1.41 1.79-1.79-1.4-1.41zM17.24 19.16l1.79 1.79 1.41-1.41-1.79-1.79-1.41 1.41zM12 6a6 6 0 100 12 6 6 0 000-12z"/></svg>';
    }

    function apply(theme){
      root.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      setIcon(theme);
      if (logo) logo.src = logos[theme];
    }

    // Initialize from html[data-theme] set in Layout
    apply(root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');

    btn.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      apply(next);
    });

    // Mobile menu logic
    const menuBtn = document.getElementById('mobileMenuBtn');
    const menu = document.getElementById('mobileMenu');

    function closeMenu(){
      if (!menu.hasAttribute('hidden')) {
        menu.setAttribute('hidden', '');
        menuBtn.setAttribute('aria-expanded', 'false');
      }
    }
    function openMenu(){
      menu.removeAttribute('hidden');
      menuBtn.setAttribute('aria-expanded', 'true');
    }

    menuBtn?.addEventListener('click', () => {
      const open = menuBtn.getAttribute('aria-expanded') === 'true';
      open ? closeMenu() : openMenu();
    });

    // Close on outside click / ESC / link click
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && !menuBtn.contains(e.target)) closeMenu();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
    menu.querySelectorAll('a').forEach(a => a.addEventListener('click', closeMenu));
  })();
</script>

<style>
  :root{
    --pill-text:#0b0b0b;
  }
  html[data-theme="dark"]{
    --pill-text:#e7e7e7;
  }
  
  .topbar{
    position: sticky; top: 0; z-index: 1000; width: 100%;
    background: var(--bg);
    border-bottom: none;
  }
  
  /* Grid: logo | menu/title | toggle/hamburger (desktop) */
  .row{
    max-width:1200px; margin:0 auto; padding:.6rem 1rem;
    display:grid; align-items:center; column-gap:1rem;
    grid-template-columns: 1fr auto 1fr;
    min-width: 0;
  }
  
  .logo-link{ display:inline-flex; align-items:center; }
  .logo{ height:32px; width:auto; display:block; }
  
  /* Desktop menu */
  .menu{
    list-style:none; margin:0; padding:.2rem;
    display:flex; gap:.75rem; align-items:center; justify-self:center;
  }
  .link{
    font-weight:600;
    color:var(--muted);
    text-decoration:none;
    transition: color .18s ease;
    padding: 0;
    background: none;
    border: none;
    box-shadow: none;
  }
  .link:hover{ color:var(--text); }
  .link.active{
    color:var(--text);
    font-weight:700;
  }
  
  /* Icon buttons (toggle + hamburger) */
  .toggle,
  .hamburger{
    appearance:none; -webkit-appearance:none;
    background:none; border:none;
    padding:.35rem; margin:0;
    display:inline-flex; align-items:center; justify-content:center;
    line-height:0; cursor:pointer;
    color: var(--text);
  }
  .toggle svg, .hamburger svg{ display:block; }
  
  /* Mobile center title */
  .page-title{
    display:none;
    font-weight:800;
    letter-spacing:-0.01em;
    min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  
  /* Mobile dropdown container */
  .mobile-menu{ position:relative; }
  
  /* Mobile list */
  .mobile-list{
    position:absolute;
    right:1rem; left:1rem;
    margin:0.25rem auto 0;
    max-width:calc(1200px - 2rem);
    list-style:none;
    padding:.4rem;
    border:1px solid var(--border);
    background:var(--bg);
    border-radius:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,.08);
  }
  .mobile-list li{ margin:0; }
  
  .mlink{
    display:block;
    padding:.75rem 1rem;
    text-decoration:none;
    color:var(--muted);
    background:none;
    border:none;
    box-shadow:none;
    transition: color .18s ease;
  }
  .mlink:hover{ color:var(--text); }
  .mlink.active{
    font-weight:700;
    color:var(--text);
  }
  
  /* Remove all outlines/boxes from links/buttons */
  .link:focus, .link:active,
  .mlink:focus, .mlink:active,
  .toggle:focus, .hamburger:focus,
  .logo-link:focus{
    outline: none;
    background: none;
    box-shadow: none;
  }
  
  /* --- RESPONSIVE --- */
  @media (max-width: 768px){
    .menu{ display:none; }                 /* hide full menu on mobile */
    .page-title{ display:block; }          /* show page title */
  
    /* Four columns: logo | title | toggle | hamburger */
    .row{
      grid-template-columns: auto 1fr auto auto;
      column-gap:.5rem;
    }
  
    .logo-link{ justify-self:start; }
    .page-title{ justify-self:center; }
    .toggle{ justify-self:end; }
    .hamburger{ justify-self:end; }
  
    .toggle:hover, .hamburger:hover{ opacity:.85; }
  }
  
  @media (min-width: 769px){
    .page-title,
    .mobile-menu,
    .hamburger{ display:none !important; }
  }
</style>

---
const raw = Astro.url.pathname || '/';
const normalize = (p: string) => {
  if (!p) return '/';
  // keep root as "/", strip trailing slashes elsewhere
  return p === '/' ? '/' : p.replace(/\/+$/, '');
};
const pathname = normalize(raw);
const active = (p: string) => (pathname === normalize(p) ? 'active' : '');
---
<nav class="topbar" aria-label="Primary">
  <div class="row">
    <!-- Left: Logo (no crop) -->
    <a href="/" class="logo-link" aria-label="Home">
      <img id="logoImg" class="logo" src="/icons/logo dark.png" alt="Logo" />
    </a>

    <!-- Center: Menu (perfectly centered) -->
    <ul class="menu" role="menubar" aria-label="Main">
      <li role="none"><a role="menuitem" class={`link ${active('/')}`} href="/">Home</a></li>
      <li role="none"><a role="menuitem" class={`link ${active('/about')}`} href="/about">About</a></li>
      <li role="none"><a role="menuitem" class={`link ${active('/projects')}`} href="/projects">Projects</a></li>
      <li role="none"><a role="menuitem" class={`link ${active('/research')}`} href="/research">Research</a></li>
    </ul>

    <!-- Right: Theme toggle -->
    <button class="toggle" id="themeToggle" aria-label="Toggle light/dark mode" title="Toggle theme">
      <span id="themeIcon" aria-hidden="true"></span>
    </button>
  </div>
</nav>

<script>
  (function(){
    const root = document.documentElement;
    const btn  = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');
    const logo = document.getElementById('logoImg');

    const logos = {
      light: "/icons/logo light.png",
      dark:  "/icons/logo dark.png"
    };

    function setIcon(theme){
      icon.innerHTML = theme === 'dark'
        ? '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21.75 14.5A9.75 9.75 0 1111.5 2.25a8 8 0 0010.25 12.25z"/></svg>'
        : '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9.83-18.16l-1.79-1.79-1.8 1.79 1.8 1.79 1.79-1.79zM20 13h3v-2h-3v2zM6.76 19.16l-1.8 1.79 1.41 1.41 1.79-1.79-1.4-1.41zM17.24 19.16l1.79 1.79 1.41-1.41-1.79-1.79-1.41 1.41zM12 6a6 6 0 100 12 6 6 0 000-12z"/></svg>';
    }

    function apply(theme){
      root.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      setIcon(theme);
      if (logo) logo.src = logos[theme];
    }

    // Initialize from html[data-theme] set in Layout
    apply(root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');

    btn.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      apply(next);
    });
  })();
</script>

<style>
  /* Pill colors by theme (adds to your global tokens) */
  :root{
    --pill-bg:#eceef2;
    --pill-border:#d9dbe3;
    --pill-text:#0b0b0b;
  }
  html[data-theme="dark"]{
    --pill-bg:#23232a;
    --pill-border:#2f2f36;
    --pill-text:#e7e7e7;
  }

  .topbar{
    position: sticky; top: 0; z-index: 1000; width: 100%;
    background: var(--bg);            /* match page background in light/dark */
    border-bottom: none; /* optional: subtle divider */
    backdrop-filter: none;            /* remove translucency/blur */
    -webkit-backdrop-filter: none;
  }

  /* Three-column grid = logo | centered menu | toggle */
  .row{
    max-width:1200px; margin:0 auto; padding:.6rem 1rem;
    display:grid; align-items:center; column-gap:1rem;
    grid-template-columns: 1fr auto 1fr;
  }

  .logo-link{ display:inline-flex; align-items:center; }
  .logo{ height:32px; width:auto; display:block; }

  .menu{
    list-style:none; margin:0; padding:.2rem;
    display:flex; gap:.5rem; align-items:center; justify-self:center;
  }
  .link{
    font-weight:700; color:var(--muted);
    padding:.5rem 1rem; border-radius:999px; border:1px solid transparent;
    text-decoration:none;
  }
  .link:hover{ background:var(--hover); color:var(--text); }
  .link.active{
    background: var(--pill-bg);
    border: none;
    color: var(--pill-text);
  }

  .toggle{
    justify-self:end;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid var(--border); background:var(--card);
    border-radius:999px; padding:.45rem .6rem; cursor:

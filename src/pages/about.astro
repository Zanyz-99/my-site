---
import Layout from "../layouts/Layout.astro";
import Container from "../components/Container.astro";

const ATHLETE_ID = Number(import.meta.env.STRAVA_ATHLETE_ID) || 35369206;
const STRAVA_PROFILE = `https://www.strava.com/athletes/${ATHLETE_ID}`;
const dataUrl = new URL('/data/strava-latest.json', Astro.url).pathname;
---
<Layout title="About | Zach Scholz" description="Background, focus areas, and interests.">
  <Container class="about-wrap">

    <!-- Accordion (custom dropdowns, one open at a time) -->
    <section class="accordion" aria-label="About sections">

      <!-- ABOUT ME -->
      <div class="acc" id="acc-about">
        <button class="acc-summary" type="button" aria-expanded="false" aria-controls="panel-about" id="btn-about">
          <span class="acc-toggle" aria-hidden="true"></span>
          <span class="acc-title">About Me</span>
        </button>
        <div class="acc-panel" id="panel-about" role="region" aria-labelledby="btn-about">
          <div class="block">
            <p>
              Naval Officer turned builder — optimization, data pipelines, and mapping. I design pragmatic tools with measurable
              outcomes, ship quickly, and iterate. Interests: vehicle routing, terrain‑aware travel‑time, and lean automations for
              finance ops. Outside of work, I’m usually running or exploring trails.
            </p>
          </div>

          <!-- Photos 4×1 (upright) -->
          <div class="photos4">
            <figure class="ph"><img src="/photos/about-1.jpg" alt="Trail photo 1" loading="lazy" /></figure>
            <figure class="ph"><img src="/photos/about-2.jpg" alt="Trail photo 2" loading="lazy" /></figure>
            <figure class="ph"><img src="/photos/about-3.jpg" alt="Build / ship / iterate" loading="lazy" /></figure>

            <!-- Dynamic Strava tile -->
            <a class="ph strava" id="strava-card" href={STRAVA_PROFILE} target="_blank" rel="noopener" aria-label="Latest Strava activity">
              <img id="strava-img" src="/photos/about-4.png" alt="Latest Strava activity" loading="lazy" />
              <span class="strava-cta">View on Strava ↗</span>
              <div class="stats" id="strava-stats" hidden></div>
            </a>
          </div>
        </div>
      </div>

      <!-- CONNECT -->
      <div class="acc" id="acc-connect">
        <button class="acc-summary" type="button" aria-expanded="false" aria-controls="panel-connect" id="btn-connect">
          <span class="acc-toggle" aria-hidden="true"></span>
          <span class="acc-title">Connect</span>
        </button>
        <div class="acc-panel" id="panel-connect" role="region" aria-labelledby="btn-connect">
          <ul class="stack dim-others" aria-label="Connect links">
            <li class="stack-item hoverable"><a href="https://www.linkedin.com/in/zachary-scholz/" target="_blank" rel="noopener">LinkedIn</a></li>
            <li class="stack-item hoverable"><a href="mailto:ztscholz86@gmail.com">Email</a></li>
            <li class="stack-item hoverable"><a href={STRAVA_PROFILE} target="_blank" rel="noopener">Strava</a></li>
          </ul>
        </div>
      </div>

      <!-- WORK -->
      <div class="acc" id="acc-work">
        <button class="acc-summary" type="button" aria-expanded="false" aria-controls="panel-work" id="btn-work">
          <span class="acc-toggle" aria-hidden="true"></span>
          <span class="acc-title">Work</span>
        </button>
        <div class="acc-panel" id="panel-work" role="region" aria-labelledby="btn-work">
          <div class="list dim-others" aria-label="Work history">
            <div class="row hoverable">
              <div class="row-line">
                <img class="logo" src="/icons/Chicago.png" alt="USS Chicago crest" />
                <div class="meta">
                  <div class="title">Reactor Control Assistant; Ops &amp; Decommissioning Lead</div>
                  <div class="sub">USS Chicago (SSN‑721) · U.S. Navy</div>
                </div>
                <div class="dates">2018–2021</div>
              </div>
            </div>

            <div class="row hoverable">
              <div class="row-line">
                <img class="logo" src="/icons/NAVEUR.png" alt="NAVEUR logo" />
                <div class="meta">
                  <div class="title">Staff Officer — Analytics &amp; Planning</div>
                  <div class="sub">Allied &amp; Fleet HQ · Naples, Italy</div>
                </div>
                <div class="dates">2023–Present</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SIDE PROJECTS -->
      <div class="acc" id="acc-projects">
        <button class="acc-summary" type="button" aria-expanded="false" aria-controls="panel-projects" id="btn-projects">
          <span class="acc-toggle" aria-hidden="true"></span>
          <span class="acc-title">Side Projects</span>
        </button>
        <div class="acc-panel" id="panel-projects" role="region" aria-labelledby="btn-projects">
          <div class="list dim-others" aria-label="Side projects">
            <a class="row hoverable" href="https://zachscholz.com/coding/FOC/">
              <div class="row-line">
                <div class="logo ph" aria-hidden="true"></div>
                <div class="meta">
                  <div class="title">FOC</div>
                  <div class="sub">Unity WebGL tactical sim</div>
                </div>
              </div>
            </a>

            <a class="row hoverable" href="https://zachscholz.com/coding/tone/">
              <div class="row-line">
                <img class="logo" src="/icons/Tone.png" alt="Tone icon" />
                <div class="meta">
                  <div class="title">Tone</div>
                  <div class="sub">Ear / reaction trainer (Unity WebGL)</div>
                </div>
              </div>
            </a>

            <a class="row hoverable" href="https://zachscholz.com/coding/sheepshead/">
              <div class="row-line">
                <img class="logo" src="/icons/Sheepshead.png" alt="Sheepshead icon" />
                <div class="meta">
                  <div class="title">Sheepshead</div>
                  <div class="sub">Trick‑taking card game (Unity WebGL)</div>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>

    </section>
  </Container>

  <!-- Accordion logic: pin accordion's top at page top; one open at a time -->
  <script type="module">
    const accRoot = document.querySelector('.accordion');
    if (!accRoot) throw new Error('Accordion root not found');
  
    const items   = Array.from(accRoot.querySelectorAll('.acc'));
    const buttons = items.map(i => i.querySelector('.acc-summary'));
    const panels  = items.map(i => i.querySelector('.acc-panel'));
  
    // OPTIONAL: if you have a fixed header (e.g., .topbar), we’ll pin just below it.
    function getPinOffset() {
      const fixedHeader = document.querySelector('.topbar'); // change selector if needed
      return fixedHeader ? Math.max(0, fixedHeader.getBoundingClientRect().bottom) : 0;
    }
  
    // Keep accordion top at the pin offset in the viewport
    function pinAccordionTop({ settle = true } = {}) {
      const targetTop = getPinOffset(); // usually 0 if no fixed header
      let tries = 0;
      let last = null;
  
      const step = () => {
        const nowTop = accRoot.getBoundingClientRect().top;
        const delta  = nowTop - targetTop;
        if (delta) window.scrollBy({ top: delta, left: 0 }); // instant correction
  
        if (!settle) return;
  
        // run for a few frames until layout stabilizes (images/fonts/etc.)
        if (last !== null && Math.abs(nowTop - last) < 0.25) {
          // two near-identical frames: close enough
          return;
        }
        last = nowTop;
        if (++tries < 16) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }
  
    let openIndex = -1;
  
    function setOpen(idx) {
      items.forEach((_, i) => {
        const open = i === idx;
        buttons[i].setAttribute('aria-expanded', String(open));
        panels[i].style.display = open ? 'block' : 'none';
      });
      openIndex = idx;
    }
  
    function activate(i, evt) {
      if (evt) evt.preventDefault();
      const next = (openIndex === i) ? -1 : i;   // toggle same to close
      setOpen(next);
  
      // On any toggle, pin the accordion to the top of the page
      pinAccordionTop({ settle: true });
    }
  
    // Wire up interactions
    buttons.forEach((btn, i) => {
      btn.addEventListener('click', (e) => activate(i, e));
      btn.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') activate(i, e);
      });
    });
  
    // Start collapsed
    setOpen(-1);
  
    // Re-pin on dynamic layout changes that happen after toggle
    const ro = new ResizeObserver(() => {
      if (openIndex !== -1) pinAccordionTop({ settle: false });
    });
    ro.observe(accRoot);
  
    // Re-pin if images inside the accordion finish loading
    accRoot.querySelectorAll('img').forEach(img => {
      if (!img.complete) {
        img.addEventListener('load', () => { if (openIndex !== -1) pinAccordionTop({ settle: false }); });
      }
    });
  
    // Prevent browser scroll-anchoring from fighting us
    document.documentElement.style.scrollBehavior = getComputedStyle(document.documentElement).scrollBehavior; // keep current behavior
    accRoot.style.contain = 'layout'; // small isolation hint
  </script>


  <!-- Strava hydrate -->
  <script type="module" define:vars={{ dataUrl }}>
    (async () => {
      const sameOrigin = dataUrl;
      const pagesOrigin = 'https://zanyz-99.github.io/my-site/data/strava-latest.json';
      const load = async (url) => {
        const r = await fetch(`${url}?ts=${Date.now()}`, { cache: 'no-store' });
        if (!r.ok) throw new Error(String(r.status));
        return r.json();
      };

      let data;
      try { data = await load(sameOrigin); }
      catch { try { data = await load(pagesOrigin); } catch {} }
      if (!data) return;

      const img = document.getElementById('strava-img');
      const statsEl = document.getElementById('strava-stats');
      const link = document.getElementById('strava-card');

      if (data.photoUrl && img) img.src = data.photoUrl;
      if (data.activityUrl && link) link.href = data.activityUrl;

      const s = data.stats;
      if (statsEl && s) {
        if (s.isRun && s.distance && s.pace && s.duration) {
          statsEl.innerHTML = `
            <span class="metric">${s.distance}</span>
            <span class="dot">•</span>
            <span class="metric">${s.pace}</span>
            <span class="dot">•</span>
            <span class="metric">${s.duration}</span>`;
        } else if (s.duration) {
          statsEl.textContent = s.duration;
        }
        statsEl.hidden = false;
      }
    })();
  </script>

  <style>
    /* Layout: center the column on the page */
    .about-wrap{display:grid;gap:36px;justify-items:center;align-items:start;margin-inline:auto}

    /* Content width (used by titles + content) */
    :root { --content-w: min(816px, 78vw); }
    .accordion{display:grid;gap:12px;justify-items:center;width:var(--content-w);margin-inline:auto}
    .acc{width:100%;background:transparent}

    /* Titles: left-aligned; fixed spot (content appears below) */
    .acc-summary{
      width:var(--content-w);
      margin-inline:auto;
      display:flex; align-items:center; gap:.6rem;
      justify-content:flex-start;
      padding:8px 0;
      cursor:pointer; user-select:none;
      color:var(--muted); font-weight:600;
      text-align:left;
      background:none; border:0;
    }
    .acc-summary:focus-visible{outline:2px solid var(--border);outline-offset:4px;border-radius:8px}
    .acc-toggle::before{content:'+'; display:inline-block; width:1ch; text-align:center}
    .acc-summary[aria-expanded="true"] .acc-toggle::before{content:'–'} /* minus when open */
    .acc-title{line-height:1.2}

    /* Panels default hidden; JS sets display:block on open */
    .acc-panel{padding:0;margin:0; display:none; overflow-anchor: none;} /* prevent scroll-anchoring jumps */

    /* Blocks share same left edge as titles; column centered overall */
    .block, .stack, .list, .photos4{
      width:var(--content-w);
      margin:6px auto 0;
    }
    .stack{list-style:none;padding:0}
    .stack-item{padding:8px 0}

    /* Dim others on hover (connect, work, projects) */
    .dim-others .hoverable{transition:opacity .15s ease}
    .dim-others:hover .hoverable{opacity:.45}
    .dim-others .hoverable:hover{opacity:1}

    /* 1-column list rows (Work & Projects) */
    .list{display:grid;gap:10px}
    .row{text-decoration:none;color:inherit}
    .row-line{display:flex;align-items:center;gap:.85rem}
    .logo{width:56px;height:auto;display:block;flex:0 0 56px;border-radius:0}
    .logo.ph{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg, color-mix(in oklab, var(--border) 30%, transparent), transparent)}
    .meta{display:grid;gap:.15rem}
    .title{line-height:1.15}
    .sub{color:inherit;font-size:.95rem}
    .dates{margin-left:auto;white-space:nowrap;color:var(--muted)}

    /* Photos 4×1 strip */
    .photos4{
      display:grid;grid-template-columns:repeat(4, 1fr);gap:16px;
    }
    .photos4 .ph{margin:0;padding:0;display:block}
    .photos4 img{
      width:100%;aspect-ratio:3/4;object-fit:cover;
      border-radius:14px;display:block;box-shadow:0 8px 24px rgba(0,0,0,.18);
    }

    /* Strava tile overlays */
    .strava{position:relative;text-decoration:none;color:inherit}
    .strava-cta{
      position:absolute;left:10px;top:10px;color:#fff;font-weight:700;
      background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;
    }
    .stats{
      position:absolute;right:10px;bottom:10px;
      display:flex;align-items:center;gap:.35rem;flex-wrap:wrap;
      background:rgba(0,0,0,.55);color:#fff;font-weight:600;
      padding:.4rem .6rem;border-radius:10px;backdrop-filter:blur(2px);
      font-size:.9rem;line-height:1;
    }
    .stats .dot{opacity:.6}
    .stats .metric{white-space:nowrap}
  </style>
</Layout>

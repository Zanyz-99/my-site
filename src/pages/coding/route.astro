---
import Layout from "../../layouts/Layout.astro";

const pageTitle = "Route — Clean Start";
const pageDesc = "Minimal Mapbox GL + Geocoder + Directions fetch.";
---

<Layout title={pageTitle} description={pageDesc}>
  <!-- Mapbox CSS/JS (deferred so they load before our inline script runs) -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" />
  <script defer src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Geocoder plugin -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.css" />
  <script defer src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.min.js"></script>

  <!-- Turf (for bounds fit helper) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{ --card:#121217; --border:#23242b; --muted:#a5a7ae; --text:#e9eaf0; --accent:#3aa1ff; }
    .wrap{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem 1.25rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .map{height:70vh;min-height:420px;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    button{background:var(--accent);color:#05121f;border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:600}
    .muted{color:var(--muted)}
    #geocoder-start .mapboxgl-ctrl-geocoder, #geocoder-end .mapboxgl-ctrl-geocoder { width:100%; max-width:unset; }
  </style>

  <div class="wrap">
    <section class="card">
      <div class="row">
        <div id="geocoder-start" class="grow"></div>
        <div id="geocoder-end" class="grow"></div>
        <button id="btn-a2b">Route A → B</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Start = red pin. End = blue pin. Click the map to set them too (first click = start, second = end).
      </div>
      <div style="margin-top:8px" class="muted">Status: <span id="status">Idle</span></div>
    </section>

    <section class="card">
      <div id="map" class="map"></div>
    </section>
  </div>

  <script is:inline>
    // ---------- CONFIG ----------
    const MAPBOX_ACCESS_TOKEN = "pk.eyJ1IjoiemFjaHNjaG9seiIsImEiOiJjbWVpZ3BsOWwwMmRlMnBuMThuZmpvdDliIn0.tIhpggDUSt0obHDUyILwhg";

    // ---------- STATE ----------
    let map, startLoc = null, endLoc = null;
    let startMarker = null, endMarker = null;
    const SRC_ID = "route-src", LINE_ID = "route-line";

    // ---------- BOOTSTRAP ----------
    window.addEventListener('load', () => {
      mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;

      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-73.9851, 40.7589], // Times Sq default
        zoom: 12
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');

      // Geocoder controls (live type-ahead)
      const geocoderStart = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl, marker: false,
        placeholder: "Start: address/place"
      });
      const geocoderEnd = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl,
